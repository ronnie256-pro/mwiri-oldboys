{% extends "base.html" %}

{% block content %}
<div class="container py-5">

  <!-- PAGE TITLE -->
  <div class="mb-5 text-center">
    <h1 class="cart-title">My Cart</h1>
    <div class="title-underline mx-auto"></div>
  </div>

  {% if cart.items.count %}
  <div class="row g-4">
    
    <!-- CART TABLE -->
    <div class="col-lg-8">
      <div class="card cart-card shadow-sm">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for item in cart.items.all %}
              <tr>
                <td>{{ item.product_name }}</td>
                <td>UGX {{ item.price|floatformat:0 }}</td>
                <td>
                  <input type="number" min="1" value="{{ item.quantity }}" data-item-id="{{ item.id }}" class="form-control item-qty" style="width:80px;">
                </td>
                <td>UGX {{ item.price|floatformat:0 }}</td>
                <td>
                  <form method="post" action="{% url 'payments:remove_cart_item' %}" class="remove-form">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ item.product_id }}">
                    <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="col-lg-4">
      <div class="card summary-card shadow-lg p-4">
        <h4 class="summary-title mb-4">Order Summary</h4>

        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal</span>
          <span>UGX {{ cart.total_amount|floatformat:0 }}</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <span>Shipping</span>
          <span>UGX 0.00</span>
        </div>

        <hr>

        <div class="d-flex justify-content-between mb-3 fw-bold fs-5">
          <span>Total</span>
          <span>UGX {{ cart.total_amount|floatformat:0 }}</span>
        </div>

        <a href="{% url 'payments:checkout' %}"
           class="btn btn-checkout w-100 mt-3">
          Proceed to Payment
        </a>
      </div>
    </div>

  </div>
  {% else %}
    <div class="text-center py-5 empty-state">
      <h4>Your cart is empty</h4>
      <p class="text-muted">Browse available items and support MOBA.</p>
    </div>
  {% endif %}
</div>

<!-- ==============================
   PREMIUM MWIRI STYLING
================================= -->
<style>
:root {
  --moba-navy: #0B1F3A;
  --moba-gold: #D4AF37;
  --moba-black: #111111;
  --moba-white: #FFFFFF;
}

/* PAGE TITLE */
.cart-title {
  font-weight: 700;
  font-size: 2.2rem;
  color: var(--moba-navy);
}

.title-underline {
  width: 80px;
  height: 4px;
  background: var(--moba-gold);
  border-radius: 4px;
  margin-top: 10px;
}

/* TABLE CARD */
.cart-card {
  border-radius: 18px;
  border: none;
  overflow: hidden;
  background: var(--moba-white);
}

.table thead {
  background: var(--moba-navy);
  color: var(--moba-white);
}

.table thead th {
  font-weight: 500;
  border: none;
}

.cart-row {
  transition: background 0.2s ease;
}

.cart-row:hover {
  background: rgba(212, 175, 55, 0.08);
}

/* INPUT */
.premium-input {
  width: 90px;
  border-radius: 10px;
  border: 1px solid #ddd;
  transition: all 0.2s ease;
}

.premium-input:focus {
  border-color: var(--moba-gold);
  box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
}

/* REMOVE BUTTON */
.btn-remove {
  background: transparent;
  color: #c0392b;
  border: 1px solid #e74c3c;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.btn-remove:hover {
  background: #e74c3c;
  color: white;
}

/* SUMMARY CARD */
.summary-card {
  border-radius: 20px;
  border: none;
  background: linear-gradient(145deg, #ffffff, #f9f9f9);
}

.summary-title {
  font-weight: 600;
  color: var(--moba-navy);
}

/* CHECKOUT BUTTON */
.btn-checkout {
  background: var(--moba-navy);
  color: var(--moba-white);
  padding: 12px;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.25s ease;
}

.btn-checkout:hover {
  background: var(--moba-gold);
  color: var(--moba-black);
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(11, 31, 58, 0.25);
}

/* EMPTY STATE */
.empty-state h4 {
  font-weight: 600;
  color: var(--moba-navy);
}

/* RESPONSIVE */
@media (max-width: 768px) {
  .cart-title {
    font-size: 1.8rem;
  }
}
</style>

<script>
  function csrfToken() {
    return '{{ csrf_token }}';
  }

  document.querySelectorAll('.item-qty').forEach(function(el){
    el.addEventListener('change', function(){
      const itemId = this.dataset.itemId;
      const qty = this.value;
      fetch('{% url "payments:update_cart_item" %}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
        body: JSON.stringify({item_id: itemId, quantity: qty})
      }).then(r=>r.json()).then(data=>{
        location.reload();
      });
    });
  });

  // Enhance remove forms to submit via AJAX when supported
  document.querySelectorAll('.remove-form').forEach(function(form){
    form.addEventListener('submit', function(e){
      e.preventDefault();
      const productId = form.querySelector('input[name="product_id"]').value;
      fetch(form.action, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken()},
        body: JSON.stringify({product_id: productId})
      }).then(r=>r.json()).then(data=>{
        location.reload();
      }).catch(()=>{
        form.submit(); // fallback
      });
    });
  });
</script>

{% endblock %}